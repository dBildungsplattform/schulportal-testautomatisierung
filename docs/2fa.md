# Setup

A (time-based) one-time password or (T)OTP is generated by providing a secret seed or key to the generator. Every 30 seconds a new password is generated, which may be used to authenticate.
The token for the base admin is manually configured in the target environment and the seed is provided in the environment via Github Action Runner. Any newly created user may setup their own token. Both setup and entry of the OTP are handled in `TwoFactorWorkflow`.

# Usage

Login works as before and the required workflow for OTP entry/setup was added into the navigation to the portal.

Please note: If 2FA is enabled in the target environment and you want to send requests to the backend, the user has to log in and **navigate into the portal to run requests against the API**, since you will only have the elevated authentication status after 2FA.
There is a helper function, that manages this for you and you should use it, if possible.

# Parallelism

In order to make parallel execution of the tests possible, we need to make sure that every worker has its own seed/token. Otherwise two workers might try to login at the same time and use the same OTP, which is not allowed.
In `global-setup` we use the base admin to create one admin per worker and setup their 2FA. Now every worker has access to its own admin. To get the credentials inside a test use `SharedCredentialManager` in conjunction with the environment variable `TEST_PARALLEL_INDEX`.

```typescript
SharedCredentialManager.getUsername(process.env['TEST_PARALLEL_INDEX']);
```

## Details

Workers in Playwright are generally isolated. Any changes to `process.env`, that happens via a worker will only exist for the lifetime of said worker. If a test fails the worker is scrapped and a new one is started and the changes to the environment are lost. To work around this you can setup the environment in `global-setup` as the environment created here will persist, even if workers are restarted. Since this requires the developer to be aware of when and where code is executed, we opted to use a **file-based approach** instead, which behaves more predictably and also persists across worker-restarts. To determine which file belongs to which worker/admin we use the provided `TEST_PARALLEL_INDEX` by Playwright.
